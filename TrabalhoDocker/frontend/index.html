<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor de Moedas</title>
    <!--CDN do Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>
<body>
    <header class="d-flex justify-content-center mt-3 mb-3">
        <h1>Conversor de Moedas</h1>
    </header>
    <section class="d-flex justify-content-center">
        <input type="text" id="conversion-input" placeholder="Digite um valor em reais">
        <button id="add-conversion">Converter</button>
    </section>
    <main class="d-flex justify-content-center mt-3">
        <table class="table table-bordered w-75">
        <thead>
            <tr>
                <th>Moeda</th>
                <th>Valor na respectiva moeda</th>
            </tr>
        </thead>
        <tbody id="conversion-table-body">
            <!-- Linhas serão inseridas aqui -->
        </tbody>
    </table>
</main>

    <script>

        // Endpoint da API a partir da qual a nossa aplicação vai se comunicar com o banco de dados
        const API_URL = 'http://localhost:3000/conversions';

        //Promises são usadas para representar operações assíncronas, ou seja:
        //- o código não para e espera a Promise terminar.
        //- outras instruções podem continuar executando normalmente enquanto a Promise é processada em segundo plano.
        function converterReal(valorReal, cotacaoMoeda) {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(valorReal / cotacaoMoeda);
                }, 500); //Delay
            });
        }

        // Apenas exibição 
        function showConversions(moeda, valor) {

            var bandeiraURL;

            const tableBody = document.getElementById('conversion-table-body');
            var row = document.createElement('tr');

            switch (moeda) {
                case 'USD':
                    bandeiraURL = 'https://th.bing.com/th/id/R.9de82d327be6e8a70af1586d0a6dcccd?rik=PGOrxV9IzDM%2bug&pid=ImgRaw&r=0'
                    break;
            
                case 'EUR':
                    bandeiraURL = 'https://www.infoescola.com/wp-content/uploads/2007/08/uniao-europeia.png'
                    break;

                case 'CAD':
                    bandeiraURL = 'https://th.bing.com/th/id/R.0425c56e677cbf86be7b70e5849a7c35?rik=NX8w4fgdO30nbg&riu=http%3a%2f%2fgeo5.net%2fimagens%2fBandeira-do-Canada.png&ehk=dluys1KRcH60LbPQiSGt%2fGXuCdKLcJAUNNqR45a7kU4%3d&risl=&pid=ImgRaw&r=0'
                    break;
            }

            row.innerHTML = `
                <td><img src="${bandeiraURL}" alt="Bandeira" width="32" height="20"> ${moeda}</td>
                <td>${valor.toFixed(2)}</td>
            `;

            tableBody.appendChild(row);

        }

        // Event listener para adicionar uma conversão
        document.getElementById('add-conversion').addEventListener('click', () => {
            const conversionInput = document.getElementById('conversion-input');
            const valorReal = conversionInput.value;

            if (valorReal) {
                addConversion(valorReal);
            }

        });

        async function addConversion(valorReal) {

            const startTime = Date.now();

            try {
                // Processamento paralelo
                const [valorDolar, valorEuro, valorCAD] = await Promise.all([
                    converterReal(valorReal, 5.6), //Conversão para Dólar
                    converterReal(valorReal, 7), // Conversão para Euro
                    converterReal(valorReal, 4.05) // Conversão para Euro
            ]);

            //(Teste para fazer processamento sequencial)
            //const valorDolar = await converterReal(valorReal, 5.6);
            //const valorEuro = await converterReal(valorReal, 7);
            //const valorCAD = await converterReal(valorReal, 4.05);

            const totalTime = Date.now() - startTime;
            console.log(`Conversões concluídas em ${totalTime} ms`);

            // Envia ao backend
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ valorReal, valorDolar, valorEuro, valorCAD })
            });

            if (response.ok) {
                console.log('Conversão salva no banco');
                document.getElementById("conversion-table-body").innerHTML = '';
                showConversions('USD',valorDolar);
                showConversions('EUR', valorEuro);
                showConversions('CAD', valorCAD);
            } else {
                console.error('Erro ao salvar conversão');
            }

            } catch (error) {
                console.error('Erro no processamento:', error);
            }
        }

    </script>
</body>
</html>